<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Edge-TTS 本地测试</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f4f8;
        color: #333;
        max-width: 700px;
        margin: 40px auto;
        padding: 20px 30px;
        box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
        border-radius: 12px;
      }
      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        font-weight: 700;
      }
      textarea {
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        font-size: 16px;
        resize: vertical;
        min-height: 150px;
        box-sizing: border-box;
        transition: border-color 0.3s ease;
      }
      textarea:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
      }
      label {
        font-weight: 600;
        display: block;
        margin-top: 20px;
        margin-bottom: 8px;
        color: #555;
      }
      select,
      input[type="range"] {
        width: 100%;
        padding: 8px 12px;
        font-size: 16px;
        border-radius: 6px;
        border: 1px solid #ccc;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }
      select:focus,
      input[type="range"]:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
      }
      #rate-label {
        display: block;
        margin-top: 5px;
        text-align: right;
        font-size: 14px;
        color: #666;
      }
      button {
        margin-top: 25px;
        width: 100%;
        padding: 14px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #2980b9;
      }
      audio {
        margin-top: 30px;
        width: 100%;
        outline: none;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      }
      .filter-select {
        flex: 1;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 15px;
        background: white;
        transition: border-color 0.3s ease;
      }
      .filter-select:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.4);
      }
    </style>
  </head>
  <body>
    <h1>Edge-TTS 本地测试</h1>

    <textarea id="text-input" placeholder="请输入文本..."></textarea>

    <div style="display: flex; gap: 10px; margin: 20px 0">
      <select id="filter-gender" class="filter-select"></select>
      <select id="filter-style" class="filter-select"></select>
      <select id="filter-language" class="filter-select"></select>
    </div>

    <label for="voice-select">选择音色：</label>
    <select id="voice-select">
      <option>加载中...</option>
    </select>

    <label for="rate-range">语速调节：</label>
    <input type="range" id="rate-range" min="-100" max="100" value="0" />
    <span id="rate-value">语速：+0%</span>

    <button id="speak-btn">生成语音</button>

    <audio id="audio-player" controls></audio>
    <button
      id="download-btn"
      style="
        display: none;
        border: none;
        background: none;
        color: #555;
        font-size: 16px;
        cursor: pointer;
        padding: 4px 8px;
      "
    >
      ⏬下载
    </button>

    <script>
      let allVoices = [];
      async function loadVoices() {
        const res = await fetch("/voices");
        if (!res.ok) return;
        allVoices = await res.json();

        populateInitialGender();
        updateFiltersAndVoices();
      }

      // 语速滑块显示更新
      const rateRange = document.getElementById("rate-range");
      const rateValue = document.getElementById("rate-value");
      rateRange.addEventListener("input", () => {
        const value = parseInt(rateRange.value);
        const sign = value >= 0 ? "+" : "";
        rateValue.textContent = `语速：${sign}${value}%`;
      });

      document.getElementById("speak-btn").onclick = async () => {
        const text = document.getElementById("text-input").value.trim();
        const voice = document.getElementById("voice-select").value;
        const rateRaw = parseInt(rateRange.value);
        const rate = (rateRaw >= 0 ? "+" : "") + rateRaw + "%";

        if (!text) {
          alert("请输入文本！");
          return;
        }

        const response = await fetch("/tts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, voice, rate }),
        });

        if (!response.ok) {
          const err = await response.json();
          alert("错误: " + err.detail);
          return;
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const audio = document.getElementById("audio-player");
        audio.src = url;
        audio.play();
        // 显示下载按钮
        const downloadBtn = document.getElementById("download-btn");
        downloadBtn.style.display = "block";

        // 设置点击下载功能
        downloadBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = url;
          a.download = "http://localhost:8000/output.mp3";
          a.click();
        };
      };
      function populateInitialGender() {
        const genderSelect = document.getElementById("filter-gender");
        const genders = new Set(allVoices.map((v) => v.性别));
        genderSelect.innerHTML = `<option value="">所有性别</option>`;
        [...genders].forEach((g) => {
          const opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          genderSelect.appendChild(opt);
        });
      }

      // 保存用户上次选择的值
      function getSelectedValue(id) {
        const el = document.getElementById(id);
        return el.value;
      }
      function setSelectedValue(id, value) {
        const el = document.getElementById(id);
        if ([...el.options].some((opt) => opt.value === value)) {
          el.value = value;
        } else {
          el.value = "";
        }
      }

      function updateFiltersAndVoices() {
        const gender = getSelectedValue("filter-gender");
        let filtered = allVoices;

        if (gender) filtered = filtered.filter((v) => v.性别 === gender);

        // 更新风格
        const styleSet = new Set();
        filtered.forEach((v) => (v.风格 || []).forEach((s) => styleSet.add(s)));
        const styleSelect = document.getElementById("filter-style");
        const prevStyle = getSelectedValue("filter-style");
        styleSelect.innerHTML = `<option value="">所有风格</option>`;
        [...styleSet].forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          styleSelect.appendChild(opt);
        });
        setSelectedValue("filter-style", prevStyle);

        // 筛选风格后再处理语言
        const selectedStyle = getSelectedValue("filter-style");
        if (selectedStyle) {
          filtered = filtered.filter((v) =>
            (v.风格 || []).includes(selectedStyle)
          );
        }

        const langSet = new Set(filtered.map((v) => v.语言));
        const langSelect = document.getElementById("filter-language");
        const prevLang = getSelectedValue("filter-language");
        langSelect.innerHTML = `<option value="">所有语言</option>`;
        [...langSet].forEach((l) => {
          const opt = document.createElement("option");
          opt.value = l;
          opt.textContent = l;
          langSelect.appendChild(opt);
        });
        setSelectedValue("filter-language", prevLang);

        const selectedLang = getSelectedValue("filter-language");
        if (selectedLang) {
          filtered = filtered.filter((v) => v.语言 === selectedLang);
        }

        // 更新 voice-select 列表
        const voiceSelect = document.getElementById("voice-select");
        voiceSelect.innerHTML = "";
        filtered.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v.名称;
          opt.textContent = `${v.名称} (${v.语言}, ${v.性别}) - ${v.风格}`;
          voiceSelect.appendChild(opt);
        });
      }

      // 联动事件绑定
      ["filter-gender", "filter-style", "filter-language"].forEach((id) => {
        document
          .getElementById(id)
          .addEventListener("change", updateFiltersAndVoices);
      });

      window.onload = loadVoices;
    </script>
  </body>
</html>
